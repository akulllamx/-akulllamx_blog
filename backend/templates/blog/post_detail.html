{% extends 'base.html' %}

{% block title %}{{ post.title }} | #akulllamx_blog{% endblock %}

{% block content %}
<div class="row">
    <article class="col-lg-8 mx-auto">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ -->
        <header class="mb-4">
            <h1 class="mb-3">{{ post.title }}</h1>
            <div class="text-muted small">
                <span><i class="fas fa-user"></i> {{ post.author.username }}</span> |
                <span><i class="fas fa-calendar"></i> {{ post.published_at|date:"j F Y" }}</span> |
                <span><i class="fas fa-eye"></i> {{ post.views_count }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
            </div>
            <hr>

            <!-- üîΩ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å / –£–¥–∞–ª–∏—Ç—å -->
            {% if user.is_staff %}
                <div class="admin-links text-end mt-2">
                    <a href="{% url 'blog:edit_post' post.slug %}" class="text-decoration-none text-warning small">
                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a> |
                    <a href="{% url 'blog:delete_post' post.slug %}" class="text-decoration-none text-danger small">
                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                    </a>
                </div>
            {% endif %}
        </header>

        <!-- –û–±–ª–æ–∂–∫–∞ -->
        {% if post.featured_image %}
            <img src="{{ post.featured_image.url }}" class="img-fluid rounded shadow-sm mb-4" alt="{{ post.title }}">
        {% endif %}

        <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
        <div class="post-content mb-4">
            {{ post.content|safe }}
        </div>

        <hr class="my-5">

        <!-- –†–µ–∞–∫—Ü–∏–∏ -->
        <div class="mb-4">
            <h5 class="mb-3"><i class="fas fa-smile"></i> –†–µ–∞–∫—Ü–∏–∏:</h5>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="addReaction({{ post.id }}, 'like')">
                    üëç Like
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="addReaction({{ post.id }}, 'love')">
                    ‚ù§Ô∏è Love
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="addReaction({{ post.id }}, 'haha')">
                    üòÇ Haha
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="addReaction({{ post.id }}, 'wow')">
                    üòÆ Wow
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="addReaction({{ post.id }}, 'sad')">
                    üò¢ Sad
                </button>
            </div>
        </div>

        <hr class="my-5">

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <section class="comments-section">
            <h3 class="mb-4"><i class="fas fa-comments"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>

            {% if user.is_authenticated %}
                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h6 class="card-title">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h6>
                        <form id="commentForm" method="post" action="{% url 'blog:add_comment' post.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <textarea class="form-control" id="commentText" name="content" rows="3" 
                                          placeholder="–¢–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info mb-4">
                    <i class="fas fa-sign-in-alt"></i> 
                    <a href="{% url 'auth:login' %}">–í–æ–π–¥–∏</a> –∏–ª–∏ 
                    <a href="{% url 'auth:register' %}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è</a> 
                    —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
                </div>
            {% endif %}

            <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
            <div id="commentsList">
                {% if post.comments.all %}
                    {% for comment in post.comments.all %}
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-subtitle mb-2 fw-bold">
                                            {{ comment.author.username }}
                                        </h6>
                                        <small class="text-muted">
                                            {{ comment.created_at|date:"j M Y, H:i" }}
                                        </small>
                                    </div>
                                    {% if user == comment.author or user.is_staff %}
                                        <a href="#" class="text-danger small" 
                                           onclick="deleteComment({{ comment.id }})">
                                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                        </a>
                                    {% endif %}
                                </div>
                                <p class="card-text mt-3">{{ comment.content }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-light border">
                        <i class="fas fa-comment-slash"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç. –ë—É–¥—å –ø–µ—Ä–≤—ã–º!
                    </div>
                {% endif %}
            </div>
        </section>
    </article>
</div>

{% block extra_js %}
<script>
    function addReaction(postId, reactionType) {
        fetch(`/api/posts/${postId}/reactions/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ reaction_type: reactionType })
        })
        .then(response => response.json())
        .then(data => alert('–†–µ–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞! ‚ù§Ô∏è'))
        .catch(error => console.error('Error:', error));
    }

    function deleteComment(commentId) {
        if (confirm('–¢—ã —É–≤–µ—Ä–µ–Ω?')) {
            fetch(`/api/comments/${commentId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(() => location.reload())
            .catch(error => console.error('Error:', error));
        }
    }
</script>
{% endblock %}
{% endblock %}
